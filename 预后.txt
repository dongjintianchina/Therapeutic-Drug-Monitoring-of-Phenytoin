-- 预后数据
SELECT DISTINCT(SUBJECT.SUBJECT_ID),
	SUBJECT.STAY_ID,
	SUBJECT.HADM_ID,
	-- 入院时间
	ICU.ADMITTIME AS ADMIT_TIME,
	-- 入ICU时间
	ICU.ICU_INTIME AS ICU_INTIME,
	-- 出院时间
	ICU.DISCHTIME AS DISCH_TIME,
	-- 出ICU时间
	ICU.ICU_OUTTIME AS ICU_OUTTIME,
	-- 入院起点
	ADMISSIONS.ADMISSION_LOCATION,
	-- 出院终点
	ADMISSIONS.DISCHARGE_LOCATION,
	-- 在医院住了多少天
	ROUND(MIMICIV_DERIVED.DATETIME_DIFF(ICU.DISCHTIME,ICU.ADMITTIME,'DAY'),2) AS HOSP_DAY,
	-- 在ICU住了多少天
	ROUND(MIMICIV_DERIVED.DATETIME_DIFF(ICU.ICU_OUTTIME,ICU.ICU_INTIME,'DAY'),2) AS ICU_DAY,
	-- 是否死亡了
	CASE WHEN ICU.DOD IS NOT NULL THEN 1 ELSE NULL END AS IS_DEAD,
	-- 死亡时间
	ICU.DOD AS DEAD_TIME,
	-- 是不是住院期间死亡
	CASE WHEN ICU.ADMITTIME<ICU.DOD AND ICU.DOD<=ICU.DISCHTIME THEN 1 ELSE 0 END AS IS_HOSP_DEAD,
	-- 是不是在ICU期间死亡
	CASE WHEN ICU.ICU_INTIME<ICU.DOD AND ICU.DOD<=ICU.ICU_OUTTIME THEN 1 ELSE 0 END AS IS_ICU_DEAD,
	-- 入院存活天数
	ROUND(MIMICIV_DERIVED.DATETIME_DIFF(ICU.DOD,ICU.ADMITTIME,'DAY'),2) AS HOSP_SURVIVAL_DAY,
	-- 入ICU存活天数
	ROUND(MIMICIV_DERIVED.DATETIME_DIFF(ICU.DOD,ICU.ICU_INTIME,'DAY'),2) AS ICU_SURVIVAL_DAY,
	-- 判断是否在入院后28天内死亡
	CASE WHEN (ICU.DOD IS NOT NULL AND 
       (MIMICIV_DERIVED.DATETIME_DIFF(ICU.DOD, ICU.ADMITTIME, 'DAY') <= 28)) THEN 1 ELSE 0
	END AS DEATH_WITHIN_HOSP_28DAYS,
	-- 判断是否在入ICU后28天内死亡
	CASE WHEN (ICU.DOD IS NOT NULL AND 
       (MIMICIV_DERIVED.DATETIME_DIFF(ICU.DOD, ICU.ICU_INTIME, 'DAY') <= 28)) THEN 1 ELSE 0
	END AS DEATH_WITHIN_ICU_28DAYS
	FROM WORK.keyan_eswofg_mimic_subject AS SUBJECT
LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.STAY_ID = ICU.STAY_ID
LEFT JOIN MIMICIV_HOSP.ADMISSIONS ON SUBJECT.HADM_ID = ADMISSIONS.HADM_ID
ORDER BY SUBJECT.SUBJECT_ID